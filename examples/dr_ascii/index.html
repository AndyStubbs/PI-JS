<!DOCTYPE html>
<html>
    <head>
        <title>Dr. Ascii</title>
        <script src="../../build/qbs.js"></script>
        <style>
            html, body {
                background-color: black;
            }
        </style>
    </head>
<body>
<script>
"use strict";

var bottle = `


           ÉÍÍÍÍÍÍÍ»
           º       º
           ÈÍ»   ÉÍ¼
             º   º
             º   º
          ÉÍÍ¼   ÈÍÍ»
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          ÈÍÍÍÍÍÍÍÍÍ¼
`;

var g = {
    "lastAnimationFrame": 0,
    "lastAnimationFrame2": 0,
    "interval": 0,
    "top": 1000,
    "speeds": { "LOW": 750, "MED": 450, "HIGH": 250 },
    "viruses": [ "~!", "@#", "$%" ],
    "game": {
        "time": 0,
        "players": 1,
        "level": 0,
        "speed": "HIGH",
        "virus": 4,
        "score": 0,
        "viruses": {
            "15_22": { "x": 15, "y": 22, "c": 4, "id": 0, "frame": 0 },
            "12_18": { "x": 12, "y": 18, "c": 54, "id": 1, "frame": 0 },
            "18_15": { "x": 18, "y": 15, "c": 44, "id": 2, "frame": 0 },
        },
        "virusCount": 3,
        "pills": {
            "15_24": { "x": 15, "y": 24, "c": 54, "id": "&" },
            "16_24": { "x": 16, "y": 24, "c": 44, "id": "&" }
        },
        "activePills": [
            [
                { "x": 15, "y": 8, "c": 4, "id": "(", "last": performance.now() },
                { "x": 16, "y": 8, "c": 44, "id": ")" }
            ]
        ],
        "virusAngle": 0
    },
    "screens": []
};

initGame();

function initGame() {
    var i;

    g.screens.push( $.screen( "256x224" ) );
    g.screens.push( $.screen( "10x10", null, true ) );

    // Viruses
    for( i = 0; i < g.screens.length; i++ ) {
        $.setScreen( g.screens[ i ] );
        $.setFont( 2 );
        $.setChar( "~", "00c33c4299663c42" );   // A0
        $.setChar( "!", "81423c425ae73c24" );   // A1
        $.setChar( "@", "005a3c5aff663c42" );   // B0
        $.setChar( "#", "00187e5a7ee73c24" );   // B1
        $.setChar( "$", "c3ff425a7ec35a66" );   // C0
        $.setChar( "%", "00ffc35aff427ee7" );   // C1
    }

    $.setScreen( g.screens[ 0 ] );

    // Pills
    $.setChar( "(", "3f7fffffffff7f3f" );   // Left
    $.setChar( ")", "fcfefffffffffefc" );   // Right
    $.setChar( "-", "3c7effffffffffff" );   // Top
    $.setChar( "_", "ffffffffffff7e3c" );   // Bottom
    $.setChar( "&", "3c7effffffff7e3c" );   // Circle

    g.time = performance.now();
    g.lastAnimationFrame = g.time;
    g.lastAnimationFrame2 = g.time;
    drawGameScreen( g.time );
}

function showIntroScreen() {
	var cols, rows, x, y, centerX, centerY, step, steps;

    $.onkey( "1", "up", startGame );
    $.onkey( "2", "up", startGame );
    animateIntro();
    g.interval = setInterval( animateIntro, 60 );
}

function animateIntro() {
    cols = $.getCols();
    rows = $.getRows();

    centerX = Math.round( cols / 2 );
    centerY = Math.round( rows / 2 ) - 1
    
    $.cls();
    $.setColor( 15 );
    $.setPos( 0, centerY - 1 );    
    $.print( "Dr. Ascii", true, true );
    $.print( "\n" );
    $.print( "1 or 2 players?", true, true );
    if( g.cnt2 < 5 ) {
        $.print( "_", true );        
    }

    $.setColor( 4 );
    
    x = centerX - 15;
    y = centerY - 5;
    step = 0;
    steps = 74;
    while( step < steps ) {
        if( step < 27 ) {
            x += 1;
        } else if( step < 37 ) {
            y += 1;
        } else if( step < 64 ) {
            x -= 1;
        } else {
            y -= 1;
        }
        $.setPos( x, y );
        if( step % 3 === g.cnt ) {
            $.print( "*", true );
        }
        step += 1;
    }

    g.cnt = ( g.cnt + 1 ) % 3;
    g.cnt2 = ( g.cnt2 + 1 ) % 10;
    //requestAnimationFrame( animateIntro );
}

function startGame( key ) {
    $.clearKeys();
    clearInterval( g.interval );
    if( key.key === "1" ) {
        g.game.draw = drawGameScreen;
    }
    $.print( key.key );
}

function drawGameScreen( timestamp ) {
    var i, virus, pill, virusTypesDrawn, x, y, a, j, cacheIndex, pill1, pill2, dt;

    dt = timestamp - g.time;
    g.time = timestamp;

    $.cls();

    //Draw Bottles
    $.setColor( 7 );
    $.print( bottle );

    // Draw Scores
    $.setColor( 8 );
    $.rect( 4, 22, 65, 43, 17 );
    $.setColor( 7 );
    $.setPos( 0, 3 );
    $.print( " TOP" );
    $.print( " " + $.util.padL( g.top, 7, "0" ) );
    $.print();
    $.print( " SCORE" );
    $.print( " " + $.util.padL( g.game.score, 7, "0" ) );

    // Draw Dr. Ascii
    $.setColor( 7 );
    $.setPos( 22, 3 );
    $.print( "Dr. Ascii" );

    // Draw Stats
    $.setColor( 8 );
    $.rect( 186, 116, 54, 88, 17 );

    // Print Level
    $.setColor( 7 );
    $.setPos( 24, 16 );
    $.print( "LEVEL" );
    $.setPos( 27, 17 );
    $.print( $.util.padL( g.game.level, 2, "0" ) );

    // Print Speed
    $.setPos( 24, 19 );
    $.print( "SPEED" );
    $.setPos( 26, 20 );
    $.print( g.game.speed );

    // Print Virus Count
    $.setPos( 24, 22 );
    $.print( "Virus" );
    $.setPos( 27, 23 );
    $.print(  $.util.padL( g.game.virusCount, 2, "0" ) );

    // Draw Big Viruses
    $.setColor( 8 );
    $.circle( 35, 150, 33, 17 );
    virusTypesDrawn = {};
    a = g.game.virusAngle;
    for( i in g.game.viruses ) {
        virus = g.game.viruses[ i ];
        if( ! virusTypesDrawn[ virus.id ] ) {
            g.screens[ 1 ].cls();
            g.screens[ 1 ].setColor( virus.c );
            g.screens[ 1 ].print(  g.viruses[ virus.id ].charAt( virus.frame ) );
            g.screens[ 1 ].render();
            x = Math.cos( a ) * 17 + 37;
            y = Math.sin( a ) * 17 + 152;
            $.drawImage( g.screens[ 1 ], x, y, null, 0.5, 0.5, null, 2, 2 );
            virusTypesDrawn[ virus.id ] = true;
            a += $.util.math.deg120;
        }
    }
    g.game.virusAngle -= 0.0005 * dt;

    // Draw Viruses
    for( i in g.game.viruses ) {
        virus = g.game.viruses[ i ];
        $.setColor( virus.c );
        $.setPos( virus.x, virus.y );
        $.print( g.viruses[ virus.id ].charAt( virus.frame ) );
        if( g.time > g.lastAnimationFrame2 + 60 ) {
            if( Math.random() * 3 < 1 ) {
                virus.frame = Math.floor( Math.random() * 2 );
            }
        }
    }

    if( g.time > g.lastAnimationFrame2 + 60 ) {
        g.lastAnimationFrame2 = g.time;
    }

    // Draw Pills
    for( i in g.game.pills ) {
        pill = g.game.pills[ i ];
        $.setColor( pill.c );
        $.setPos( pill.x, pill.y );
        $.print( pill.id );
    }

    // Draw Active Pills
    for( i = 0; i < g.game.activePills.length; i++ ) {
        for( j = 0; j < g.game.activePills[ i ].length; j++ ) {
            pill = g.game.activePills[ i ][ j ];
            $.setColor( pill.c );
            $.setPos( pill.x, pill.y );
            $.print( pill.id );
        }
    }

    // Move Active Pills

    for( i = 0; i < g.game.activePills.length; i++ ) {
        pill1 = g.game.activePills[ i ][ 0 ];
        if( g.time > pill1.last + g.speeds[ g.game.speed ] ) {
            pill1.last = g.time;
            pill2 = g.game.activePills[ i ][ 1 ];
            for( j = 0; j < g.game.activePills[ i ].length; j++ ) {
                pill = g.game.activePills[ i ][ j ];
                pill.y += 1;
                cacheIndex = pill.x + "_" + pill.y;
                if( g.game.pills[ cacheIndex ] || g.game.viruses[ cacheIndex ] ) {
                    pill.y -= 1;
                    if( j === 1 ) {
                        g.game.activePills[ i ][ 0 ].y = pill.y;
                    }
                    g.game.pills[ pill1.x + "_" + pill1.y ] = pill1;
                    g.game.pills[ pill2.x + "_" + pill2.y ] = pill2;
                    g.game.activePills.splice( i, 1 );
                    break;
                }
            }
        }
    }

    requestAnimationFrame( drawGameScreen );
}
</script>
</body>
</html>

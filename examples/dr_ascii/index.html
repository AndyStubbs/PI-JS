<!DOCTYPE html>
<html>
    <head>
        <title>Dr. Ascii</title>
        <link rel="icon" type="image/x-icon" href="favicon.png">
        <script src="../../build/qbs.js"></script>
        <style>
            html, body {
                background-color: black;
            }
        </style>
    </head>
<body>
<script>
"use strict";

var drAscii1 = `
                          o_
                         /--\\ 
                       \\\\<" |
                        \\/  \\ 
                         |\\/|\\ 
                         \\  /\\ 
                         ||||
                        <=<=]
`;
var drAscii1Pills = [ [ 22, 6, "(" ], [ 23, 6, ")" ] ];

var drAscii2 = `
                          o_
                         /--\\
                         <" |
                         /  \\ 
                        /|\\/|\\
                        /\\  /\\
                         ||||
                        <=<=]
`;
var drAscii2Pills = [ [ 23, 9, "{" ], [ 23, 10, "}" ] ];


var drAscii3 = `
                          o_
                         /--\\
                         |''|
                         /' \\ 
                        /|\\/|\\
                        /\\  /\\
                         ||||
                        <=][=>
`;
var drAscii3Pills = [ [ 23, 9, "{" ], [ 23, 10, "}" ] ];


var drAscii4 = `
                          o_
                         /--\\
                         |\`\`|
                         / '\\ 
                        /|\\/|\\
                        /\\  /\\
                         ||||
                        <=][=>
`;
var drAscii4Pills = [ [ 23, 9, "{" ], [ 23, 10, "}" ] ];

var drAscii5 = `
                          o_
                         /--\\
                         |\`\`|
                         / '\\/ 
                        /|\\/|/
                        /\\  /
                         ||||
                        <=][=>
`;
var drAscii5Pills = [ [ 23, 9, "{" ], [ 23, 10, "}" ] ];

var drAscii6 = `
                          o_
                         /--\\
                         <" |
                       \\\\/  \\ 
                        \\|\\/|\\
                         \\  /\\
                         ||||
                        <=<=]
`;
var drAscii6Pills = [ [ 23, 6, "{" ], [ 23, 7, "}" ] ];

var bottle = `


           ÉÍÍÍÍÍÍÍ»
           º       º
           ÈÍ»   ÉÍ¼
             º   º
             º   º
          ÉÍÍ¼   ÈÍÍ»
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          º         º
          ÈÍÍÍÍÍÍÍÍÍ¼
`;

var g = {
    "animations": [ drAscii2, drAscii3, drAscii4, drAscii5, drAscii6, drAscii1 ],
    "animationPills": [ drAscii2Pills, drAscii3Pills, drAscii4Pills, drAscii5Pills, drAscii6Pills, drAscii1Pills ],
    "animationFrame": 0,
    "animationDelay": 1000,
    "lastAnimationFrame": 0,
    "lastAnimationFrame2": 0,
    "interval": 0,
    "top": 1000,
    "speeds": { "LOW": 750, "MED": 450, "HIGH": 200 },
    "fastFallSpeed": 25,
    "scores": { "LOW": 100, "MED": 200, "HIGH": 300 },
    "viruses": [ "~!", "#$", "%^" ],
    "pills": [ "(", ")", "{", "}" ],
    "rotations": [
        [  0,  0,  1,  0, "(", ")" ],
        [  0, -1,  0,  0, "{", "}" ],
        [  1,  0,  0,  0, ")", "(" ],
        [  0,  0,  0, -1, "}", "{" ]
    ],
    "colors": [ 4, 54, 44 ],
    "moveDelay": 200,
    "rotateDelay": 200,
    "game": {
        "nextPill": null,
        "throwingPill": true,
        "finishedThrowing": false,
        "time": 0,
        "players": 1,
        "level": 0,
        "speed": "HIGH",
        "virus": 4,
        "score": 0,
        "pillScore": 0,
        "viruses": {
            "15_22": { "x": 15, "y": 22, "c": 4, "id": 0, "frame": 0 },
            "12_18": { "x": 12, "y": 18, "c": 54, "id": 1, "frame": 0 },
            "18_15": { "x": 18, "y": 15, "c": 44, "id": 2, "frame": 0 },
        },
        "virusCount": 3,
        "pills": {
            "15_24": { "x": 15, "y": 24, "c": 54, "id": "&" },
            "16_24": { "x": 16, "y": 24, "c": 44, "id": "&" },
            "15_21": { "x": 15, "y": 21, "c": 4, "id": "&" },
            "15_20": { "x": 15, "y": 20, "c": 4, "id": "&" }
        },
        "activePills": [],
        "movePill": null,
        "virusAngle": 0,
        "left": 10,
        "right": 20,
        "floor": 25,
        "moveX": 0,
        "rotate": 0,
        "fastFall": false,
        "lastMove": performance.now(),
        "lastRotate": performance.now()
    },
    "screens": []
};

initGame();

function initGame() {
    var i;

    g.screens.push( $.screen( "256x224" ) );
    g.screens.push( $.screen( "10x10", null, true ) );

    // Viruses
    for( i = 0; i < g.screens.length; i++ ) {
        $.setScreen( g.screens[ i ] );
        $.setFont( 2 );
        $.setChar( "~", "00c33c4299663c42" );   // A0
        $.setChar( "!", "81423c425ae73c24" );   // A1
        $.setChar( "#", "005a3c5aff663c42" );   // B0
        $.setChar( "$", "00187e5a7ee73c24" );   // B1
        $.setChar( "%", "c3ff425a7ec35a66" );   // C0
        $.setChar( "^", "00ffc35aff427ee7" );   // C1
    }

    $.setScreen( g.screens[ 0 ] );

    // Pills
    $.setChar( "(", "3f7fffffffff7f3f" );   // Left
    $.setChar( ")", "fcfefffffffffefc" );   // Right
    $.setChar( "{", "3c7effffffffffff" );   // Top
    $.setChar( "}", "ffffffffffff7e3c" );   // Bottom
    $.setChar( "&", "3c7effffffff7e3c" );   // Circle

    g.time = performance.now();
    g.lastAnimationFrame = g.time;
    g.lastAnimationFrame2 = g.time;

    setupGameInput();
    getNextPill();
    setupThrowAnimation();
    run( g.time );
}

function setupGameInput() {
    $.onkey( "ArrowLeft", "down", function () {
        g.game.moveX = -1;
    } );
    $.onkey( "ArrowLeft", "up", function () {
        g.game.moveX = 0;
        g.game.lastMove = 0;
    } );
    $.onkey( "ArrowRight", "down", function () {
        g.game.moveX = 1;
    } );
    $.onkey( "ArrowRight", "up", function () {
        g.game.moveX = 0;
        g.game.lastMove = 0;
    } );
    $.onkey( "ArrowUp", "down", function () {
        g.game.rotate = true;
    } );
    $.onkey( "ArrowUp", "up", function () {
        g.game.rotate = false;
        g.game.lastRotate = 0;
    } );
    $.onkey( "ArrowDown", "down", function () {
        g.game.fastFall = true;
    } );
    $.onkey( "ArrowDown", "up", function () {
        g.game.fastFall = false;
    } );
}

function showIntroScreen() {
	var cols, rows, x, y, centerX, centerY, step, steps;

    $.onkey( "1", "up", startGame );
    $.onkey( "2", "up", startGame );
    animateIntro();
    g.interval = setInterval( animateIntro, 60 );
}

function animateIntro() {
    cols = $.getCols();
    rows = $.getRows();

    centerX = Math.round( cols / 2 );
    centerY = Math.round( rows / 2 ) - 1
    
    $.cls();
    $.setColor( 15 );
    $.setPos( 0, centerY - 1 );    
    $.print( "Dr. Ascii", true, true );
    $.print( "\n" );
    $.print( "1 or 2 players?", true, true );
    if( g.cnt2 < 5 ) {
        $.print( "_", true );        
    }

    $.setColor( 4 );
    
    x = centerX - 15;
    y = centerY - 5;
    step = 0;
    steps = 74;
    while( step < steps ) {
        if( step < 27 ) {
            x += 1;
        } else if( step < 37 ) {
            y += 1;
        } else if( step < 64 ) {
            x -= 1;
        } else {
            y -= 1;
        }
        $.setPos( x, y );
        if( step % 3 === g.cnt ) {
            $.print( "*", true );
        }
        step += 1;
    }

    g.cnt = ( g.cnt + 1 ) % 3;
    g.cnt2 = ( g.cnt2 + 1 ) % 10;
    //requestAnimationFrame( animateIntro );
}

function startGame( key ) {
    $.clearKeys();
    clearInterval( g.interval );
    if( key.key === "1" ) {
        g.game.draw = drawGameScreen;
    }
    $.print( key.key );
}

function run( timestamp ) {
    let dt = timestamp - g.time;
    g.time = timestamp;

    drawGameScreen( timestamp, dt );
    moveGameObjects( timestamp, dt );
    requestAnimationFrame( run );
}

function drawGameScreen( timestamp, dt ) {
    var i, virus, pill, virusTypesDrawn, x, y, a, j, cacheIndex, pillData;

    $.cls();

    //Draw Bottles
    $.setColor( 7 );
    $.print( bottle );

    // Draw Scores
    $.setColor( 8 );
    $.rect( 4, 22, 65, 43, 17 );
    $.setColor( 7 );
    $.setPos( 0, 3 );
    $.print( " TOP" );
    $.print( " " + $.util.padL( g.top, 7, "0" ) );
    $.print();
    $.print( " SCORE" );
    $.print( " " + $.util.padL( g.game.score, 7, "0" ) );

    // Draw Dr. Ascii
    $.setColor( 7 );
    $.setPos( 22, 3 );
    $.print( "Dr. Ascii" );
    $.print( g.animations[ g.animationFrame ] );

    // Draw Next Pill
    if( g.game.finishedThrowing ) {
        pillData = g.animationPills[ g.animationFrame ]; 
        $.setColor( g.game.nextPill.c );
        $.setPos( pillData[ 0 ][ 0 ], pillData[ 0 ][ 1 ] );
        $.print( pillData[ 0 ][ 2 ] );
        $.setColor( g.game.nextPill.partner.c );
        $.setPos( pillData[ 1 ][ 0 ], pillData[ 1 ][ 1 ] );
        $.print( pillData[ 1 ][ 2 ] );
    }

    // Draw Stats
    $.setColor( 8 );
    $.rect( 186, 116, 54, 88, 17 );

    // Print Level
    $.setColor( 7 );
    $.setPos( 24, 16 );
    $.print( "LEVEL" );
    $.setPos( 27, 17 );
    $.print( $.util.padL( g.game.level, 2, "0" ) );

    // Print Speed
    $.setPos( 24, 19 );
    $.print( "SPEED" );
    $.setPos( 26, 20 );
    $.print( g.game.speed );

    // Print Virus Count
    $.setPos( 24, 22 );
    $.print( "Virus" );
    $.setPos( 27, 23 );
    $.print(  $.util.padL( g.game.virusCount, 2, "0" ) );

    // Draw Big Viruses
    $.setColor( 8 );
    $.circle( 35, 150, 33, 17 );
    virusTypesDrawn = {};
    a = g.game.virusAngle;
    for( i in g.game.viruses ) {
        virus = g.game.viruses[ i ];
        if( ! virusTypesDrawn[ virus.id ] ) {
            g.screens[ 1 ].cls();
            g.screens[ 1 ].setColor( virus.c );
            g.screens[ 1 ].print(  g.viruses[ virus.id ].charAt( virus.frame ) );
            g.screens[ 1 ].render();
            x = Math.cos( a ) * 17 + 37;
            y = Math.sin( a ) * 17 + 152;
            $.drawImage( g.screens[ 1 ], x, y, null, 0.5, 0.5, null, 2, 2 );
            virusTypesDrawn[ virus.id ] = true;
            a += $.util.math.deg120;
        }
    }
    g.game.virusAngle -= 0.0005 * dt;

    // Draw Viruses
    for( i in g.game.viruses ) {
        virus = g.game.viruses[ i ];
        $.setColor( virus.c );
        $.setPos( virus.x, virus.y );
        $.print( g.viruses[ virus.id ].charAt( virus.frame ) );
        if( g.time > g.lastAnimationFrame2 + 60 ) {
            if( Math.random() * 3 < 1 ) {
                virus.frame = Math.floor( Math.random() * 2 );
            }
        }
    }

    if( g.time > g.lastAnimationFrame2 + 60 ) {
        g.lastAnimationFrame2 = g.time;
    }

    // Draw Pills
    for( i in g.game.pills ) {
        pill = g.game.pills[ i ];
        $.setColor( pill.c );
        $.setPos( pill.x, pill.y );
        $.print( pill.id, true );
    }

    // Draw Active Pills
    for( i = 0; i < g.game.activePills.length; i++ ) {
        pill = g.game.activePills[ i ];
        $.setColor( pill.c );
        $.setPos( pill.x, pill.y );
        $.print( pill.id, true );
    }

}

function moveGameObjects( timestamp, dt ) {
    var i, pill, cacheIndex, pillDropped, speed;

    pillDropped = false;

    // Move Active Pills
    for( i = g.game.activePills.length - 1; i >= 0; i-- ) {
        pill = g.game.activePills[ i ];

        if(
            g.game.fastFall && g.game.movePill &&
            ( pill === g.game.movePill || pill === g.game.movePill.partner )
        ) {
            speed = g.fastFallSpeed;
        } else {
            speed = g.speeds[ g.game.speed ];
        }
        // Check if ready to drop
        if( g.time > pill.last + speed ) {
            pill.last = g.time;
            pill.y += 1;
            pill.baseY += 1;
            cacheIndex = pill.x + "_" + pill.y;
            if( 
                g.game.pills[ cacheIndex ] ||
                g.game.viruses[ cacheIndex ] ||
                pill.status === "stopped" ||
                pill.y > g.game.floor
            ) {
                pill.status = "stopped";
                pill.y -= 1;
                pill.baseY -= 1;
                g.game.pills[ pill.x + "_" + pill.y ] = pill;
                g.game.activePills.splice( i, 1 );

                if( pill === g.game.movePill || pill.partner === g.game.movePill ) {
                    g.game.movePill = null;
                }

                // If partner is active flag it to be stopped
                if( pill.partner ) {
                    if( pill.partner.status === "active" ) {
                        pill.partner.status = "stopped";
                    }

                    // If partner has already moved - then move it back up
                    if( pill.order === 0 ) {
                        pill.partner.y -= 1;
                        g.game.pills[ pill.partner.x + "_" + pill.partner.y ] = pill.partner;
                        g.game.activePills.splice( i, 1 );
                    }

                    // Decouple Pills
                    pill.partner.partner = null;
                    pill.partner = null;
                }

                pillDropped = true;
            }
        }
    }

    if( pillDropped ) {
        findMatches();
        freefall();
    }

    if( g.game.activePills.length === 0 && ! g.game.throwingPill  ) {
        g.game.score += g.game.pillScore;
        g.game.pillScore = 0;
        setupThrowAnimation();
    }

    if( timestamp > g.lastAnimationFrame + g.animationDelay ) {
        if( g.game.throwingPill ) {
            g.animationFrame = 0;
            throwPill();
            getNextPill();
            g.game.finishedThrowing = false;
        } else {
            g.animationFrame = Math.floor( Math.random() * ( g.animations.length - 1 ) );
            g.game.finishedThrowing = true;
        }
        g.lastAnimationFrame = timestamp;
    }

    handleInput( timestamp );
}

function handleInput( timestamp ) {
    var cacheIndex, cacheIndex2;

    if( ! g.game.movePill ) {
        return;
    }
    if( g.game.rotate && timestamp > g.game.lastRotate + g.rotateDelay ) {
        g.game.movePill.rotation = ( g.game.movePill.rotation + 1 ) % 4;
        g.game.movePill.x = g.game.movePill.baseX + g.rotations[ g.game.movePill.rotation ][ 0 ];
        g.game.movePill.y = g.game.movePill.baseY + g.rotations[ g.game.movePill.rotation ][ 1 ];
        g.game.movePill.partner.x = g.game.movePill.baseX + g.rotations[ g.game.movePill.rotation ][ 2 ];
        g.game.movePill.partner.y = g.game.movePill.baseY + g.rotations[ g.game.movePill.rotation ][ 3 ];
        g.game.movePill.id = g.rotations[ g.game.movePill.rotation ][ 4 ];
        g.game.movePill.partner.id = g.rotations[ g.game.movePill.rotation ][ 5 ];
        g.game.lastRotate = timestamp;

        // If up against right wall make sure to bounce back
        if( g.game.movePill.x >= g.game.right || g.game.movePill.partner.x >= g.game.right ) {
            g.game.movePill.x -= 1;
            g.game.movePill.baseX -= 1;
            g.game.movePill.partner.x -= 1;
        }
    }

    if( g.game.moveX !== 0 && timestamp > g.game.lastMove + g.moveDelay ) {
        g.game.movePill.baseX += g.game.moveX;
        g.game.movePill.x += g.game.moveX;
        g.game.movePill.partner.x += g.game.moveX;

        cacheIndex = g.game.movePill.x + "_" + g.game.movePill.y;
        cacheIndex2 = g.game.movePill.partner.x + "_" + g.game.movePill.partner.y;

        if(
            g.game.pills[ cacheIndex ] || g.game.pills[ cacheIndex2 ] ||
            g.game.viruses[ cacheIndex ] || g.game.viruses[ cacheIndex2 ] ||
            g.game.movePill.x <= g.game.left ||
            g.game.movePill.x >= g.game.right ||
            g.game.movePill.partner.x <= g.game.left ||
            g.game.movePill.partner.x >= g.game.right
        ) {
            g.game.movePill.baseX -= g.game.moveX;
            g.game.movePill.x -= g.game.moveX;
            g.game.movePill.partner.x -= g.game.moveX;
        } else {
            g.game.lastMove = timestamp;
        }
    }
}

function getNextPill() {
    g.game.nextPill = {
        "x": 15, "y": 7, "c": g.colors[ Math.floor( Math.random() * g.colors.length ) ],
        "baseX": 15, "baseY": 8,
        "id": "(", "last": performance.now(),
        "status": "active", "order": 0, "rotation": 0
    };
    g.game.nextPill.partner = {
        "x": 16, "y": 7, "c": g.colors[ Math.floor( Math.random() * g.colors.length ) ],
        "id": ")", "last": performance.now(),
        "status": "active", "order": 1
    };
    g.game.nextPill.partner.partner = g.game.nextPill;
}

function setupThrowAnimation() {
    g.animationFrame = g.animations.length - 1;
    g.lastAnimationFrame = performance.now();
    g.game.throwingPill = true;
    g.game.finishedThrowing = true;
}

function throwPill() {
    g.animationFrame = 0;
    g.lastAnimationFrame = performance.now();
    g.game.throwingPill = false;
    addActivePill( g.game.nextPill );
    addActivePill( g.game.nextPill.partner );
    g.game.movePill = g.game.nextPill;
}

function findMatches() {
    var i, pill, matches, j;

    for( i in g.game.pills ) {
        pill = g.game.pills[ i ];
        matches = getMatches( pill.x, pill.y, pill.c );
        if( matches.length >= 4 ) {
            for( j = 0; j < matches.length; j++ ) {
                if( g.game.pills[ matches[ j ] ] ) {
                    delete g.game.pills[ matches[ j ] ];
                } else if( g.game.viruses[ matches[ j ] ] ) {
                    if( g.game.pillScore === 0 ) {
                        g.game.pillScore = g.scores[ g.game.speed ];
                    } else {
                        g.game.pillScore *= 2;
                    }
                    delete g.game.viruses[ matches[ j ] ];
                    g.game.virusCount -= 1;
                }
            }
        }
    }
}

function addActivePill( pill ) {
    g.game.activePills.push( pill );
    g.game.activePills.sort( function ( a, b ) {
        return a.y > b.y;
    } );
}

function getMatches( x, y, c ) {
    var x2, y2, matches, found;

    // Count Horizontal
    matches = [];
    found = true;
    x2 = x;
    while( found ) {
        x2 -= 1;
        found = checkMatch( x2 + "_" + y, c );
    }
    found = true;
    while( found ) {
        x2 += 1;
        found = checkMatch( x2 + "_" + y, c );
        if( found ) {
            matches.push( x2 + "_" + y );
        }
    }

    if( matches.length > 3 ) {
        return matches;
    }
    
    // Count Vertical
    matches = [];
    found = true;
    y2 = y;
    while( found ) {
        y2 -= 1;
        found = checkMatch( x + "_" + y2, c );
    }
    found = true;
    while( found ) {
        y2 += 1;
        found = checkMatch( x + "_" + y2, c );
        if( found ) {
            matches.push( x + "_" + y2 );
        }
    }

    return matches;
}

function checkMatch( index, c ) {
    return (
        ( g.game.pills[ index ] && g.game.pills[ index ].c === c ) ||
        ( g.game.viruses[ index ] && g.game.viruses[ index ].c === c )
    );
}

function freefall() {
    var i, pill, fallers, j, isFreeFall;

    // Move Active Pills
    g.cache = {};
    for( i in g.game.pills ) {
        if( g.cache[ i ] ) {
            continue;
        }
        pill = g.game.pills[ i ];
        fallers = [];
        isFreeFall = getFreeFallers( pill.x, pill.y, fallers );
        if( isFreeFall ) {
            for( j = 0; j < fallers.length; j++ ) {
                pill = g.game.pills[ fallers[ j ] ];
                pill.last = performance.now();
                pill.status = "active";
                pill.id = "&";
                addActivePill( pill );

                delete g.game.pills[ fallers[ j ] ];
            }
        }
    }
}

function getFreeFallers( x, y, fallers ) {
    var index, isFreeFall, checks, i, x2, y2;

    checks = [ [ -1, 0 ], [ 1, 0 ], [ 0, -1 ], [ 0, 1 ] ];
    isFreeFall = true;
    index = x + "_" + y;
    fallers.push( index );
    g.cache[ index ] = true;

    // Loop through all directions
    for( i = 0; i < checks.length; i++ ) {
        x2 = x + checks[ i ][ 0 ];
        y2 = y + checks[ i ][ 1 ];
        index = x2 + "_" + y2;
        if( ! g.cache[ index ] && g.game.pills[ index ] ) {
            isFreeFall &= getFreeFallers( x2, y2, fallers );
        } else if( g.game.viruses[ index ] || y2 > g.game.floor ) {
            isFreeFall = false;
        }
    }

    return isFreeFall;
}

</script>
</body>
</html>
